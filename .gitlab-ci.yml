stages:
  - build
  - test
  - deploy

services:
  - name: docker:dind  # «docker‑in‑docker» – создаём образ локально 
    alias: docker  
variables:
  # Внутренний docker‑двигатель
  DOCKER_DRIVER: overlay2
  # Имя образа, который будет держаться только в CI‑runner’е
  IMAGE_NAME: mytexteditor
  IMAGE_TAG: "$CI_COMMIT_SHA"
  DOCKER_TLS_CERTDIR: "" # Выключаете сертификаты, чтобы docker:dind работал без TLS.

# ---------- 1️⃣ Build stage ----------
build:
  stage: build
  image: docker:27  # «docker»‑образ с клиентом
  script:
    - docker info
    # Билдим и сохраняем в tar, чтобы тесты и деплой смогли «загрузить»
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker save -o $IMAGE_NAME.tar $IMAGE_NAME:$IMAGE_TAG
    - ls -lh $IMAGE_NAME.tar   # проверяем размер
  artifacts:
    # Делаем tar‑файл доступным для следующих job‑ов
    paths:
    - ${IMAGE_NAME}.tar
  tags:
    - build

# ---------- 2️⃣ Test stage ----------
test:
  stage: test
  image: docker:27
  dependencies:
    - build
  script:
    # Загружаем образ, чтобы потом можно было запустить контейнер
    - docker load -i $IMAGE_NAME.tar
    # Устанавливаем зависимости и запускаем тесты внутри контейнера
    - docker run --rm -w /app $IMAGE_NAME:$IMAGE_TAG /bin/sh -c "PYTHONPATH=$PWD pip install -r app/requirements.txt && pip install pytest && PYTHONPATH=$PWD pytest tests/"
  tags:
    - test

# ---------- 3️⃣ Deploy stage ----------
deploy:
  stage: deploy
  image: docker:27
  environment:
    name: production
    url: https://mytexteditor.example.com
  dependencies:
    - build
  script:
    # 1) Загружаем образ (если не в тесте)
    - docker load -i $IMAGE_NAME.tar
    # 2) Отправляем его на удалённый Docker‑host (или на Kubernetes)
    - echo "Deploying $IMAGE_NAME:$IMAGE_TAG to production ..."
    # Пример для удалённого Docker‑host через ssh:
    - ssh $PROD_USER@$PROD_HOST "docker load -i /tmp/$IMAGE_NAME.tar && docker run -d -p 80:80 --name mytexteditor $IMAGE_NAME:$IMAGE_TAG"
  only:
    - main
  tags:
    - deploy
